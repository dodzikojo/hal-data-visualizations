<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACC Roles Distribution Report</title>
    <style>
        :root {
            --primary-font: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --background-color: #f8f9fa;
            --text-color: #333;
            --header-color: #2c3e50;
            --border-color: #dee2e6;
            --tab-active-border: #3498db;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--primary-font);
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.7;
            font-size: 16px;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            /* Mobile-first */
            width: 100%;
            min-height: 100vh;
        }

        h2 {
            color: var(--header-color);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .chart-container {
            flex: 1;
            padding: 1rem;
            /* Reduced padding for mobile */
            min-height: 600px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
        }

        .chart-iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
        }

        .explanation-container {
            padding: 2rem;
            background-color: #f0f0f0;
            /* Light grey background */
            display: flex;
            /* Make it a flex container for tabs */
            flex-direction: column;
        }

        .tab-nav {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .tab-link {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            margin-bottom: -2px;
            /* Overlap the container's border */
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s ease;
        }

        .tab-link:hover {
            color: var(--header-color);
        }

        .tab-link.active {
            border-bottom-color: var(--tab-active-border);
            color: var(--header-color);
            font-weight: 600;
        }

        .tab-content-container {
            /* padding-top: 1.5rem; */
            flex: 1;
            /* Allow tab content to grow */
            overflow-y: auto;
            /* Enable scrolling for tab content */
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f2f2f2;
        }

        .roles-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .role-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 8px;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .role-item:hover {
            background-color: #f8f9fa;
        }

        .role-name {
            flex: 1;
            font-size: 0.95rem;
            color: var(--text-color);
            word-break: break-word;
        }

        .copy-btn {
            padding: 8px;
            margin-left: 10px;
            background-color: var(--tab-active-border);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .copy-btn:hover {
            background-color: #2980b9;
        }

        .copy-btn:active {
            background-color: #21618c;
        }

        .copy-btn.copied {
            background-color: #27ae60;
        }

        .copy-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .roles-count {
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--header-color);
        }

        .no-roles {
            text-align: center;
            color: #999;
            padding: 2rem;
            font-style: italic;
        }

        .roles-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .roles-header h2 {
            margin: 0;
        }

        .copy-all-btn {
            padding: 8px 16px;
            background-color: var(--tab-active-border);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .copy-all-btn:hover {
            background-color: #2980b9;
        }

        .copy-all-btn:active {
            background-color: #21618c;
        }

        .copy-all-btn.copied {
            background-color: #27ae60;
        }

        .copy-all-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-box {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--tab-active-border);
        }

        .search-box::placeholder {
            color: #999;
        }

        .clear-search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            color: #999;
            transition: color 0.2s ease;
        }

        .clear-search-btn:hover {
            color: #333;
        }

        .clear-search-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .clear-search-btn.visible {
            display: flex;
        }

        /* Role Builder Styles */
        .role-builder-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Wizard & Breadcrumb Styles */
        .breadcrumb-nav {
            display: flex;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0;
            margin-bottom: 0rem;
            list-style: none;
            overflow: hidden;
        }

        .breadcrumb-item {
            flex: 1;
            text-align: center;
            padding: 0.75rem 1rem;
            color: #6c757d;
            font-weight: 500;
            text-decoration: none;
            position: relative;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .breadcrumb-item:hover:not(.active) {
            background-color: #e9ecef;
            color: #495057;
        }

        .breadcrumb-item.active {
            color: #0d6efd;
            background-color: #e9ecef;
            /* Slightly darker than base */
            font-weight: 700;
        }

        .breadcrumb-item.completed {
            color: #198754;
        }

        .breadcrumb-item::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 1px;
            height: 70%;
            background-color: #dee2e6;
        }

        .breadcrumb-item:last-child::after {
            display: none;
        }

        /* Wizard Steps */
        .builder-step {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .builder-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .nav-btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5c636a;
        }

        .btn-primary {
            background-color: var(--tab-active-border);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #198754;
            color: white;
        }

        .btn-success:hover {
            background-color: #157347;
        }

        /* Override Lists for Wizard Mode */
        .builder-step .level-list-container {
            max-height: 50vh;
            /* Much taller for wizard mode */
            height: 400px;
        }

        /* Selection Summary Styles */
        .selection-summary {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #1565c0;
        }

        .summary-item {
            display: inline-block;
            margin-right: 1.5rem;
        }

        .summary-label {
            font-weight: 600;
            color: #555;
            margin-right: 4px;
        }


        .level-selector {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .level-selector label {
            font-weight: 600;
            color: var(--header-color);
            font-size: 0.9rem;
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #666;
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: #2196F3;
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(16px);
        }

        .level-search-container {
            position: relative;
        }

        .level-search-box {
            width: 100%;
            padding: 8px 32px 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px 4px 0 0;
            font-size: 0.9rem;
            background-color: #fff;
        }

        .level-search-box:focus {
            outline: none;
            border-color: var(--tab-active-border);
        }

        .level-clear-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            display: none;
            color: #999;
        }

        .level-clear-btn.visible {
            display: block;
        }

        .level-clear-btn:hover {
            color: #333;
        }

        .level-list-container {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            background-color: #fff;
        }

        .level-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .level-list-item {
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.15s ease;
        }

        .level-list-item:last-child {
            border-bottom: none;
        }

        .level-list-item:hover {
            background-color: #f5f5f5;
        }

        .level-list-item.selected {
            background-color: #e3f2fd;
        }

        .level-list-item.hidden {
            display: none;
        }

        .level-checkbox {
            width: 16px;
            height: 16px;
            accent-color: var(--tab-active-border);
            pointer-events: none;
        }

        .level-no-results {
            padding: 12px;
            color: #999;
            font-style: italic;
            text-align: center;
            font-size: 0.85rem;
        }

        .selection-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.5rem;
            min-height: 24px;
        }

        .selection-chip {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .selection-chip .remove-chip {
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            line-height: 1;
        }

        .selection-chip .remove-chip:hover {
            color: #c62828;
        }

        .generate-btn {
            padding: 12px 24px;
            background-color: var(--tab-active-border);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
            margin-top: 0.5rem;
        }

        .generate-btn:hover {
            background-color: #2980b9;
        }

        .generate-btn:active {
            background-color: #21618c;
        }

        .generated-roles-section {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        .generated-roles-section .roles-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .generated-roles-section .roles-list li {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .generated-roles-section .roles-list li:last-child {
            border-bottom: none;
        }

        .generated-roles-section .roles-list li:hover {
            background-color: #f8f9fa;
        }

        /* Role Table Styles */
        .roles-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .roles-table th,
        .roles-table td {
            text-align: left;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .roles-table th {
            background-color: #ffffff;
            color: var(--header-color);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 16px 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .roles-table tr:hover {
            background-color: #f8f9fa;
        }

        .roles-table .level-cell {
            color: #666;
            font-size: 0.8rem;
        }

        .roles-table .role-cell {
            font-weight: 500;
        }

        .roles-table-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            background-color: white;
            border-radius: 4px;
        }

        #Roles {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        #Roles.active {
            display: flex;
        }

        #RoleBuilder {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        #RoleBuilder.active {
            display: flex;
        }

        .role-builder-container {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .builder-step {
            flex: 1;
            display: none;
            flex-direction: column;
            min-height: 0;
        }

        .builder-step.active {
            display: flex;
        }

        .level-list-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }

        @media (min-width: 1200px) {
            .main-container {
                flex-direction: row;
            }

            .chart-container {
                flex-basis: 65%;
            }

            .explanation-container {
                flex-basis: 35%;
                border-left: 1px solid var(--border-color);
                max-height: 100vh;
                /* Constrain height to viewport */
            }
        }

        /* Snackbar notification styles */
        .snackbar {
            visibility: hidden;
            min-width: 280px;
            max-width: 90%;
            background-color: #323232;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 14px 20px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .snackbar.show {
            visibility: visible;
            animation: snackbar-fadein 0.3s, snackbar-fadeout 0.3s 4.7s;
        }

        .snackbar-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
        }

        .snackbar-message {
            flex: 1;
        }

        .snackbar-action {
            background: none;
            border: none;
            color: #4fc3f7;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 13px;
            text-transform: uppercase;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .snackbar-action:hover {
            background-color: rgba(79, 195, 247, 0.15);
        }

        @keyframes snackbar-fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes snackbar-fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <!-- Snackbar notification -->
    <div id="snackbar" class="snackbar">
        <svg class="snackbar-icon" viewBox="0 0 24 24" fill="currentColor">
            <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
        </svg>
        <span class="snackbar-message" id="snackbarMessage">Roles filtered! Click the Roles tab to view.</span>
        <button class="snackbar-action" onclick="navigateToRolesTab()">View</button>
    </div>
    <main class="main-container">
        <section class="chart-container">
            <iframe class="chart-iframe" src="_chart_only.html"></iframe>
        </section>
        <aside class="explanation-container">
            <div class="tab-nav">
                <button class="tab-link active" onclick="openTab(event, 'About')">About This Chart</button>
                <button class="tab-link" onclick="openTab(event, 'RoleBuilder')">Role Builder</button>
                <button class="tab-link" onclick="openTab(event, 'Roles')">Roles</button>
            </div>
            <div class="tab-content-container">
                <div id="About" class="tab-content active">
                    <h2>About This Chart</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"><strong>Last Generated:</strong>
                        <span id="chartGeneratedDate">January 08, 2026 at 04:09 PM</span>
                    </p>
                    <p style="margin-top: 0rem; border-top: 1px solid #eee; padding-top: 0rem;">For further information
                        about this chart and underlying roles, reach out to <strong>Dodzi
                            Agbenorku, Digital Asset Information Lead, Long Term Growth, Heathrow Airport
                            Limited.</strong></p>

                    <h3>1. What It Is: "The Big Picture"</h3>
                    <p>This sunburst chart is an interactive, hierarchical map of every role in Autodesk Construction
                        Cloud (ACC) created for the Development Consent Order (DCO). It visualises the relationships
                        between parties, their functions, and their specific roles.</p>

                    <h3>2. How to Read It</h3>
                    <ul>
                        <li><strong>Inner Ring (The "Who"):</strong> Represents the various contractual parties,
                            including the client (HAL)</li>
                        <li><strong>Middle Ring (The "What"):</strong> Shows the functional roles within each
                            contractual party.</li>
                        <li><strong>Outer Ring (The Full Role):</strong> The exact ACC scope/ discipline related to the
                            contractual party.</li>
                    </ul>

                    <h3>3. How to Use Role Builder</h3>
                    <p>Use the <a href="#" onclick="openTab(event, 'RoleBuilder')"
                            style="color: var(--tab-active-border); text-decoration: underline; cursor: pointer;">Role
                            Builder tab</a> to dynamically explore valid role combinations.</p>
                    <ul>
                        <li><strong>Select a Party (Level 1):</strong> Choose the contractual party (e.g., "Lead
                            Designer"). Use the toggle to switch between single and multi-select modes.</li>
                        <li><strong>Select a Function (Level 2):</strong> Filter available functions based on your Level
                            1 selection.</li>
                        <li><strong>Select a Discipline (Level 3):</strong> See the specific disciplines available for
                            the selected Party and Function.</li>
                        <li><strong>Generate Roles:</strong> Click "Generate Role List" to see the full list of ACC
                            roles matching your criteria.</li>
                    </ul>

                    <h3>4. Why It's Useful</h3>
                    <p>This tool helps answer critical questions about project governance, resource allocation, and
                        security by turning a complex role list into an intuitive map.</p>

                    <h3>5. Viewing & Copying Roles</h3>
                    <p>You can view all outer ring roles in a searchable list by visiting the <a href="#"
                            onclick="openTab(event, 'Roles')"
                            style="color: var(--tab-active-border); text-decoration: underline; cursor: pointer;">Roles
                            tab</a>. The list updates dynamically based on your chart selection and includes a
                        copy-to-clipboard button for each role.</p>

                    <h2 style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">Examples in Practice
                    </h2>
                    <p>The table below illustrates how the three levels combine to form clear, logical roles for various
                        project participants.</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>Level 1 (Party)</th>
                                <th>Level 2 (Function)</th>
                                <th>Level 3 (Discipline)</th>
                                <th>Resulting ACC Role</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Architect from lead design firm uploading drawings</td>
                                <td>Lead Designer</td>
                                <td>General</td>
                                <td>Architecture</td>
                                <td>Lead Designer - General - Architecture</td>
                            </tr>
                            <tr>
                                <td>HAL's central document control team</td>
                                <td>HAL</td>
                                <td>Document Controller</td>
                                <td>All</td>
                                <td>HAL - Document Controller - All</td>
                            </tr>
                        </tbody>
                    </table>

                    <h2>Reasoning & Key Advantages</h2>
                    <p>Adopting this structured approach provides significant, measurable benefits for a programme of
                        this scale and duration.</p>

                    <h2>Handling Exceptions: The "All" Discipline</h2>
                    <p>The "All" discipline is reserved for programme-level or project-wide functions.</p>

                    <h2>Governance and Adherence</h2>
                    <p>The long-term success of this strategy depends on strict governance and consistent application.
                    </p>


                </div>
                <div id="Roles" class="tab-content">
                    <div class="roles-header">
                        <h2>Role List</h2>
                        <button class="copy-all-btn" id="copyAllBtn" onclick="copyAllRoles()"
                            title="Copy all displayed roles">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path
                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                            </svg>
                            Copy All
                        </button>
                    </div>
                    <div class="search-container">
                        <input type="text" class="search-box" id="roleSearch" placeholder="Search roles..."
                            oninput="filterRoles()">
                        <button class="clear-search-btn" id="clearSearchBtn" onclick="clearSearch()"
                            title="Clear search">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" />
                            </svg>
                        </button>
                    </div>
                    <p class="roles-count" id="rolesCount">Loading roles...</p>
                    <div class="roles-table-container">
                        <table class="roles-table" id="rolesTable">
                            <thead>
                                <tr>
                                    <th>Level 1 (Party)</th>
                                    <th>Level 2 (Function)</th>
                                    <th>Level 3 (Discipline)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rolesTableBody">
                                <tr>
                                    <td colspan="4" class="no-roles">Select a segment in the chart to view roles</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="RoleBuilder" class="tab-content">
                    <h2>Role Builder</h2>

                    <!-- Wizard Breadcrumbs -->
                    <div class="breadcrumb-nav">
                        <div class="breadcrumb-item active" id="crumb1" onclick="if(canGoToStep(1)) goToStep(1)">
                            <span>1. Pick Party</span>
                        </div>
                        <div class="breadcrumb-item" id="crumb2" onclick="if(canGoToStep(2)) goToStep(2)">
                            <span>2. Pick Function</span>
                        </div>
                        <div class="breadcrumb-item" id="crumb3" onclick="if(canGoToStep(3)) goToStep(3)">
                            <span>3. Pick Discipline</span>
                        </div>
                        <div class="breadcrumb-item" id="crumb4" onclick="if(canGoToStep(4)) goToStep(4)">
                            <span>4. Results</span>
                        </div>
                    </div>

                    <div class="role-builder-container">

                        <!-- STEP 1: PARTY -->
                        <div class="builder-step active" id="step1">
                            <h3>Step 1: Select Party</h3>
                            <p style="color: #666; margin-bottom: 0.5rem; font-size: 0.9em;">Who is the contractual
                                party? (e.g., Lead Designer, Contractor)</p>

                            <div class="level-selector">
                                <div class="level-header">
                                    <label>Level 1 (Party)</label>
                                    <div class="multi-select-toggle">
                                        <span>Multi-select</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="level1MultiSelect"
                                                onchange="onMultiSelectToggle()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="level-search-container">
                                    <input type="text" class="level-search-box" id="level1Search"
                                        placeholder="Search parties..." oninput="filterLevelOptions(1)">
                                    <button class="level-clear-btn" id="level1ClearBtn"
                                        onclick="clearLevelSearch(1)">âœ•</button>
                                </div>
                                <div class="level-list-container">
                                    <ul class="level-list" id="level1List">
                                        <li class="level-no-results">Loading...</li>
                                    </ul>
                                </div>
                                <div class="selection-chips" id="level1Chips"></div>
                            </div>

                            <div class="step-navigation" style="justify-content: flex-end;">
                                <button class="nav-btn btn-primary" onclick="goToStep(2)">Next: Select Function
                                    &rarr;</button>
                            </div>
                        </div>

                        <!-- STEP 2: FUNCTION -->
                        <div class="builder-step" id="step2">
                            <h3>Step 2: Select Function</h3>
                            <div id="step2Summary" class="selection-summary" style="display:none;"></div>
                            <p style="color: #666; margin-bottom: 0.5rem; font-size: 0.9em;">What is the role's
                                function? (e.g., Checker, Approver)</p>
                            <p id="generalDefaultNote"
                                style="color: #17a2b8; margin-bottom: 0.5rem; font-size: 0.85em; font-style: italic; display: none;">
                                <strong>Note:</strong> "General" is included by default when available.
                            </p>

                            <div class="level-selector">
                                <label>Level 2 (Function)</label>
                                <div class="level-search-container">
                                    <input type="text" class="level-search-box" id="level2Search"
                                        placeholder="Search functions..." oninput="filterLevelOptions(2)">
                                    <button class="level-clear-btn" id="level2ClearBtn"
                                        onclick="clearLevelSearch(2)">âœ•</button>
                                </div>
                                <div class="level-list-container">
                                    <ul class="level-list" id="level2List">
                                        <li class="level-no-results">Select Level 1 first</li>
                                    </ul>
                                </div>
                                <div class="selection-chips" id="level2Chips"></div>
                            </div>

                            <div class="step-navigation">
                                <button class="nav-btn btn-secondary" onclick="goToStep(1)">&larr; Back</button>
                                <button class="nav-btn btn-primary" onclick="goToStep(3)">Next: Select Discipline
                                    &rarr;</button>
                            </div>
                        </div>

                        <!-- STEP 3: DISCIPLINE -->
                        <div class="builder-step" id="step3">
                            <h3>Step 3: Select Discipline</h3>
                            <div id="step3Summary" class="selection-summary" style="display:none;"></div>
                            <p style="color: #666; margin-bottom: 0.5rem; font-size: 0.9em;">What is the specific
                                discipline? (e.g., Architecture, Fire)</p>
                            <p id="allDefaultNote"
                                style="color: #17a2b8; margin-bottom: 0.5rem; font-size: 0.85em; font-style: italic; display: none;">
                                <strong>Note:</strong> "All" is included by default when available.
                            </p>

                            <div class="level-selector">
                                <label>Level 3 (Discipline)</label>
                                <div class="level-search-container">
                                    <input type="text" class="level-search-box" id="level3Search"
                                        placeholder="Search disciplines..." oninput="filterLevelOptions(3)">
                                    <button class="level-clear-btn" id="level3ClearBtn"
                                        onclick="clearLevelSearch(3)">âœ•</button>
                                </div>
                                <div class="level-list-container">
                                    <ul class="level-list" id="level3List">
                                        <li class="level-no-results">Select Level 2 first</li>
                                    </ul>
                                </div>
                                <div class="selection-chips" id="level3Chips"></div>
                            </div>

                            <div class="step-navigation">
                                <button class="nav-btn btn-secondary" onclick="goToStep(2)">&larr; Back</button>
                                <button class="nav-btn btn-success" onclick="generateRolesWizard()">Generate Role List
                                    &rarr;</button>
                            </div>
                        </div>

                        <!-- STEP 4: RESULTS -->
                        <div class="builder-step" id="step4">
                            <h3>Step 4: Generated Roles</h3>
                            <div id="step4Summary" class="selection-summary" style="display:none;"></div>
                            <p style="color: #666; margin-bottom: 0.5rem; font-size: 0.9em;">Here are the roles that
                                match your selections.</p>

                            <div class="generated-roles-section" id="generatedRolesSection"
                                style="display: block; border-top: none; margin-top: 0;">
                                <div class="roles-header">
                                    <h3 id="generatedRolesCount">Generated Roles</h3>
                                    <button class="copy-all-btn" onclick="copyAllGeneratedRoles(this)"
                                        title="Copy all generated roles">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path
                                                d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                                        </svg>
                                        Copy All
                                    </button>
                                </div>
                                <ul class="roles-list" id="generatedRolesList" style="max-height: 50vh;"></ul>

                                <!-- Shareable URL Section -->
                                <div class="shareable-url-section" id="shareableUrlSection"
                                    style="margin-top: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                                    <p style="margin: 0 0 0.5rem 0; font-size: 0.85em; color: #666;">
                                        <strong>ðŸ’¡ Share this selection:</strong> Copy the URL below to share this role
                                        configuration with others.
                                    </p>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="text" id="shareableUrl" readonly
                                            style="flex: 1; padding: 8px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.8em; background: #fff; color: #495057;">
                                        <button class="copy-btn" onclick="copyShareableUrl()" title="Copy URL"
                                            style="padding: 8px 12px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                                style="width: 16px; height: 16px;">
                                                <path
                                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="step-navigation">
                                <button class="nav-btn btn-secondary" onclick="goToStep(3)">&larr; Back to
                                    Disciplines</button>
                                <button class="nav-btn btn-primary" onclick="resetWizard()">Start Over â†º</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </aside>
    </main>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            // Update URL hash without scrolling
            if (history.pushState) {
                history.pushState(null, null, '#' + tabName);
            } else {
                location.hash = tabName;
            }

            // If Roles tab is opened, update the roles list
            if (tabName === 'Roles') {
                updateRolesList();
            }

            // If Role Builder tab is opened, populate the dropdowns
            if (tabName === 'RoleBuilder') {
                populateRoleBuilderSelects();
            }
        }

        // Track the currently active copy button to maintain check state
        let activeCopyButton = null;

        function copyToClipboard(text, button) {
            // If clicking the same button that is already active/checked, just re-copy but don't toggle visual state
            if (activeCopyButton === button) {
                navigator.clipboard.writeText(text).catch(err => console.error('Failed to copy text: ', err));
                return;
            }

            navigator.clipboard.writeText(text).then(function () {
                // If there is another button currently showing "Copied", reset it
                if (activeCopyButton && activeCopyButton !== button) {
                    const originalContent = activeCopyButton.getAttribute('data-original-content');
                    if (originalContent) {
                        activeCopyButton.innerHTML = originalContent;
                    }
                    activeCopyButton.classList.remove('copied');
                    activeCopyButton = null;
                }

                // Save original content for the clicked button if not already saved
                if (!button.getAttribute('data-original-content')) {
                    button.setAttribute('data-original-content', button.innerHTML);
                }

                // Set new state
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';
                button.classList.add('copied');

                // Update global reference
                activeCopyButton = button;

            }).catch(function (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy to clipboard');
            });
        }

        // Cached chart data received from iframe via postMessage
        let cachedChartData = null;
        let lastClickedData = null;

        // Role hierarchy data - auto-generated by generate_chart.py
        // Maps Level 1 -> Level 2 -> [Level 3 values]
        const roleHierarchy = {
            "AP1": {
                "Approver": [
                    "Railhead"
                ],
                "BIM Lead/Information Manager": [
                    "Railhead"
                ],
                "Checker": [
                    "Railhead"
                ],
                "Design/Project Manager": [
                    "Railhead"
                ],
                "Document Controller": [
                    "Railhead"
                ],
                "General": [
                    "All",
                    "Railhead"
                ]
            },
            "Consent": {
                "Approver": [
                    "All"
                ],
                "Checker": [
                    "All"
                ],
                "Document Controller": [
                    "All"
                ],
                "General": [
                    "All"
                ]
            },
            "Delivery Planning": {
                "Approver": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "BIM Lead/Information Manager": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "Checker": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "Design/Project Manager": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "Document Controller": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "General": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "All",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ]
            },
            "Environment": {
                "Approver": [
                    "All"
                ],
                "BIM Lead/Information Manager": [
                    "All"
                ],
                "Checker": [
                    "All"
                ],
                "Design/Project Manager": [
                    "All"
                ],
                "Document Controller": [
                    "All"
                ],
                "General": [
                    "All"
                ]
            },
            "HAL": {
                "Approver": [
                    "Consent",
                    "Delivery Planning",
                    "Design and Engineering",
                    "Environment",
                    "Land and Property",
                    "Legal and Advisory",
                    "Masterplanning",
                    "Programme Management",
                    "Surface Access"
                ],
                "BIM Lead/Information Manager": [
                    "Consent",
                    "Delivery Planning",
                    "Design and Engineering",
                    "Environment",
                    "Land and Property",
                    "Legal and Advisory",
                    "Masterplanning",
                    "Programme Management",
                    "Surface Access"
                ],
                "Checker": [
                    "Consent",
                    "Delivery Planning",
                    "Design and Engineering",
                    "Environment",
                    "Land and Property",
                    "Legal and Advisory",
                    "Masterplanning",
                    "Programme Management",
                    "Surface Access"
                ],
                "Design/Project Manager": [
                    "Consent",
                    "Delivery Planning",
                    "Design and Engineering",
                    "Environment",
                    "Land and Property",
                    "Legal and Advisory",
                    "Masterplanning",
                    "Programme Management",
                    "Surface Access"
                ],
                "Document Controller": [
                    "Consent",
                    "Delivery Planning",
                    "Design and Engineering",
                    "Environment",
                    "Land and Property",
                    "Legal and Advisory",
                    "Masterplanning",
                    "Programme Management",
                    "Surface Access"
                ],
                "General": [
                    "All",
                    "Consent",
                    "Delivery Planning",
                    "Design and Engineering",
                    "Environment",
                    "Land and Property",
                    "Legal and Advisory",
                    "Masterplanning",
                    "Programme Management",
                    "Surface Access"
                ]
            },
            "Land and Property": {
                "Approver": [
                    "All"
                ],
                "BIM Lead/Information Manager": [
                    "All"
                ],
                "Checker": [
                    "All"
                ],
                "Design/Project Manager": [
                    "All"
                ],
                "Document Controller": [
                    "All"
                ],
                "General": [
                    "All"
                ]
            },
            "Lead Designer": {
                "Approver": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "BIM Lead/Information Manager": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "Checker": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "Design/Project Manager": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "Document Controller": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ],
                "General": [
                    "Active Travel",
                    "Airfield Systems",
                    "Airport Related Development (ARD)",
                    "Airport Support Facilities",
                    "Airside Roads",
                    "All",
                    "Aprons",
                    "Baggage",
                    "Bus and Coach",
                    "Communication Networks",
                    "Compliance",
                    "Connectivity (Airside PTS)",
                    "Connectivity (Landside PTS)",
                    "Consent Support",
                    "Decants & Relocations",
                    "Displacements",
                    "Earthworks",
                    "Fuel Networks",
                    "Green Loop",
                    "Heathrow Interface",
                    "Land Use",
                    "Landscaping",
                    "Landside Roads (LHR Owned)",
                    "Landside Terminal Zone",
                    "Logistics",
                    "Maintenance Repair Overhaul",
                    "Motorways",
                    "Open Space",
                    "PAX Buildings Architecture",
                    "PAX Buildings Structure",
                    "Parking",
                    "Power Networks",
                    "Rail",
                    "Railhead",
                    "Roads",
                    "Roads LTZ",
                    "Runways",
                    "Runways & Taxiways",
                    "Scheme Integration",
                    "Southern Rail",
                    "Systems",
                    "Taxiways",
                    "Utilities Diversions",
                    "Water Networks",
                    "Water Systems",
                    "Western Rail"
                ]
            },
            "Legal and Advisory": {
                "Approver": [
                    "All"
                ],
                "Checker": [
                    "All"
                ],
                "General": [
                    "All"
                ]
            },
            "Surface Access": {
                "Approver": [
                    "All"
                ],
                "BIM Lead/Information Manager": [
                    "All"
                ],
                "Checker": [
                    "All"
                ],
                "Design/Project Manager": [
                    "All"
                ],
                "Document Controller": [
                    "All"
                ],
                "General": [
                    "All"
                ]
            }
        }; // ROLE_HIERARCHY_PLACEHOLDER

        function extractOuterRingRoles() {
            try {
                // First, try to use cached chart data from iframe
                if (cachedChartData) {
                    const labels = cachedChartData.labels;
                    const ids = cachedChartData.ids;
                    const parents = cachedChartData.parents;

                    // Find outer ring roles (those with parents that are not empty and have grandparents)
                    const outerRoles = [];
                    for (let i = 0; i < labels.length; i++) {
                        const parent = parents[i];

                        // Check if this is an outer ring (has a parent and that parent has a parent)
                        if (parent && parent !== '') {
                            const parentIndex = ids.indexOf(parent);
                            if (parentIndex !== -1 && parents[parentIndex] && parents[parentIndex] !== '') {
                                outerRoles.push(labels[i]);
                            }
                        }
                    }

                    return [...new Set(outerRoles)].sort();
                }

                // Fallback: Extract all roles from roleHierarchy
                if (Object.keys(roleHierarchy).length > 0) {
                    const roles = [];
                    for (const l1 of Object.keys(roleHierarchy)) {
                        for (const l2 of Object.keys(roleHierarchy[l1])) {
                            for (const l3 of roleHierarchy[l1][l2]) {
                                roles.push(`${l1} - ${l2} - ${l3}`);
                            }
                        }
                    }
                    return roles.sort();
                }

                return [];
            } catch (error) {
                console.error('Error extracting roles:', error);
                return [];
            }
        }

        // Store the previous clicked ID to detect when we click the same item again (going back)
        let previousClickedId = null;
        // Store the current filter ID (computed at click time, not during render)
        let currentFilterId = null;

        function getSelectedRoles() {
            try {
                if (!cachedChartData) {
                    return null;
                }

                // Use the pre-computed filter ID (set at click time)
                if (!currentFilterId) {
                    return null;
                }

                // Get all descendants of the filter segment that are outer ring roles
                const selectedRoles = [];
                for (let i = 0; i < cachedChartData.ids.length; i++) {
                    // Check if this node is a descendant of the target segment
                    if (isDescendant(cachedChartData.ids[i], currentFilterId, cachedChartData.ids, cachedChartData.parents)) {
                        // Only add outer ring roles (roles that have a parent with a parent)
                        const nodeParent = cachedChartData.parents[i];
                        if (nodeParent && nodeParent !== '') {
                            const parentIndex = cachedChartData.ids.indexOf(nodeParent);
                            if (parentIndex !== -1 && cachedChartData.parents[parentIndex] && cachedChartData.parents[parentIndex] !== '') {
                                selectedRoles.push(cachedChartData.labels[i]);
                            }
                        }
                    }
                }

                // If no roles found for this selection, return null to show all roles
                return selectedRoles.length > 0 ? [...new Set(selectedRoles)].sort() : null;
            } catch (error) {
                console.error('Error getting selected roles:', error);
                return null;
            }
        }

        function isDescendant(nodeId, ancestorId, ids, parents) {
            if (nodeId === ancestorId) return true;

            let currentId = nodeId;
            const visited = new Set();

            while (currentId && currentId !== '' && !visited.has(currentId)) {
                visited.add(currentId);
                const index = ids.indexOf(currentId);
                if (index === -1) break;

                const parent = parents[index];
                if (parent === ancestorId) return true;
                currentId = parent;
            }

            return false;
        }

        // Store the current roles list globally for search filtering
        let currentRolesList = [];
        let currentlyDisplayedRoles = [];
        let isCurrentlyFiltered = false;

        function updateRolesList() {
            const rolesList = document.getElementById('rolesList');
            const rolesCount = document.getElementById('rolesCount');
            const searchBox = document.getElementById('roleSearch');

            // Try to get selected roles first, if none, get all roles
            let roles = getSelectedRoles();
            isCurrentlyFiltered = roles !== null;

            if (!roles) {
                roles = extractOuterRingRoles();
            }

            if (roles.length === 0) {
                const rolesTableBody = document.getElementById('rolesTableBody');
                rolesTableBody.innerHTML = '<tr><td colspan="4" class="no-roles">No roles found. Please wait for chart to load.</td></tr>';
                rolesCount.textContent = 'No roles available';
                currentRolesList = [];
                return;
            }

            // Store the full list for search filtering
            currentRolesList = roles;

            // If there is a search value (e.g. from URL), apply filter
            if (searchBox && searchBox.value.trim() !== '') {
                filterRoles();
            } else {
                // Display the roles
                displayRoles(roles, isCurrentlyFiltered);
            }
        }

        // Parse a role name into L1, L2, L3 components
        function parseRoleParts(roleName) {
            const parts = roleName.split(' - ');
            return {
                level1: parts[0] || '',
                level2: parts[1] || '',
                level3: parts[2] || '',
                fullRole: roleName
            };
        }

        function displayRoles(roles, isFiltered) {
            const rolesTableBody = document.getElementById('rolesTableBody');
            const rolesCount = document.getElementById('rolesCount');

            // Store currently displayed roles for copy all functionality
            currentlyDisplayedRoles = roles;

            const countText = isFiltered
                ? `Showing ${roles.length} role${roles.length !== 1 ? 's' : ''} (filtered by selection)`
                : `Showing all ${roles.length} role${roles.length !== 1 ? 's' : ''}`;
            rolesCount.textContent = countText;

            rolesTableBody.innerHTML = roles.map(role => {
                const parts = parseRoleParts(role);
                return `
                    <tr>
                        <td class="level-cell">${parts.level1}</td>
                        <td class="level-cell">${parts.level2}</td>
                        <td class="level-cell">${parts.level3}</td>
                        <td>
                            <button class="copy-btn" onclick="copyToClipboard('${role.replace(/'/g, "\\'")}', this)" title="Copy full role name">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterRoles() {
            const searchBox = document.getElementById('roleSearch');
            const rolesTableBody = document.getElementById('rolesTableBody');
            const rolesCount = document.getElementById('rolesCount');
            const clearBtn = document.getElementById('clearSearchBtn');
            const searchTerm = searchBox.value.toLowerCase().trim();

            // Show/hide clear button based on search box content
            if (searchBox.value.length > 0) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }

            if (currentRolesList.length === 0) {
                return;
            }

            if (searchTerm === '') {
                // Show all current roles when search is empty
                displayRoles(currentRolesList, isCurrentlyFiltered);
                return;
            }

            // Filter roles based on search term
            const filteredRoles = currentRolesList.filter(role =>
                role.toLowerCase().includes(searchTerm)
            );

            // Update URL search param
            const url = new URL(window.location);
            if (searchTerm) {
                url.searchParams.set('search', searchTerm);
            } else {
                url.searchParams.delete('search');
            }
            // Use replaceState to not flood history
            history.replaceState(null, '', url);

            // Store currently displayed roles for copy all functionality
            currentlyDisplayedRoles = filteredRoles;

            if (filteredRoles.length === 0) {
                rolesTableBody.innerHTML = '<tr><td colspan="4" class="no-roles">No roles match your search</td></tr>';
                rolesCount.textContent = 'No matches found';
                return;
            }

            // Display filtered roles with updated count
            const baseText = isCurrentlyFiltered ? '(filtered by selection)' : '';
            rolesCount.textContent = `Showing ${filteredRoles.length} of ${currentRolesList.length} role${currentRolesList.length !== 1 ? 's' : ''} ${baseText}`.trim();

            rolesTableBody.innerHTML = filteredRoles.map(role => {
                const parts = parseRoleParts(role);
                // Highlight the search term in each part
                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                const highlightL1 = parts.level1.replace(regex, '<mark>$1</mark>');
                const highlightL2 = parts.level2.replace(regex, '<mark>$1</mark>');
                const highlightL3 = parts.level3.replace(regex, '<mark>$1</mark>');

                return `
                    <tr>
                        <td class="level-cell">${highlightL1}</td>
                        <td class="level-cell">${highlightL2}</td>
                        <td class="level-cell">${highlightL3}</td>
                        <td>
                            <button class="copy-btn" onclick="copyToClipboard('${role.replace(/'/g, "\\'")}', this)" title="Copy full role name">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function clearSearch() {
            const searchBox = document.getElementById('roleSearch');
            const clearBtn = document.getElementById('clearSearchBtn');
            searchBox.value = '';
            clearBtn.classList.remove('visible');
            filterRoles();
            searchBox.focus();
        }

        function copyAllRoles() {
            const copyAllBtn = document.getElementById('copyAllBtn');

            if (currentlyDisplayedRoles.length === 0) {
                alert('No roles to copy');
                return;
            }

            // Join all roles with newline character
            const allRolesText = currentlyDisplayedRoles.join('\n');

            navigator.clipboard.writeText(allRolesText).then(function () {
                const originalHTML = copyAllBtn.innerHTML;
                copyAllBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                    </svg>
                    Copied!
                `;
                copyAllBtn.classList.add('copied');
                setTimeout(function () {
                    copyAllBtn.innerHTML = originalHTML;
                    copyAllBtn.classList.remove('copied');
                }, 2000);
            }).catch(function (err) {
                console.error('Failed to copy all roles: ', err);
                alert('Failed to copy to clipboard');
            });
        }

        // ========== ROLE BUILDER FUNCTIONS ==========

        // Store generated roles for copy functionality
        let generatedRolesList = [];

        // Store selected values for each level
        const levelSelections = {
            1: new Set(),
            2: new Set(),
            3: new Set()
        };

        // Get available Level 1 values from hierarchy
        function getAvailableLevel1() {
            return Object.keys(roleHierarchy).sort();
        }

        // Get available Level 2 values based on selected Level 1 values
        function getAvailableLevel2() {
            if (levelSelections[1].size === 0) {
                return [];
            }

            const level2Set = new Set();
            levelSelections[1].forEach(l1 => {
                if (roleHierarchy[l1]) {
                    Object.keys(roleHierarchy[l1]).forEach(l2 => level2Set.add(l2));
                }
            });

            return [...level2Set].sort();
        }

        // Get available Level 3 values based on selected Level 1 and Level 2 values
        function getAvailableLevel3() {
            if (levelSelections[1].size === 0 || levelSelections[2].size === 0) {
                return [];
            }

            const level3Set = new Set();
            levelSelections[1].forEach(l1 => {
                if (roleHierarchy[l1]) {
                    levelSelections[2].forEach(l2 => {
                        if (roleHierarchy[l1][l2]) {
                            roleHierarchy[l1][l2].forEach(l3 => level3Set.add(l3));
                        }
                    });
                }
            });

            return [...level3Set].sort();
        }

        // Populate the Role Builder searchable lists
        function populateRoleBuilderSelects() {
            if (Object.keys(roleHierarchy).length === 0) {
                // Hierarchy not loaded yet
                return;
            }

            renderLevelList(1, getAvailableLevel1());
            renderLevelList(2, getAvailableLevel2());
            renderLevelList(3, getAvailableLevel3());
        }

        // Render a level list with clickable items
        function renderLevelList(level, values) {
            const listEl = document.getElementById(`level${level}List`);
            const searchBox = document.getElementById(`level${level}Search`);
            const searchTerm = searchBox ? searchBox.value.toLowerCase().trim() : '';

            // Handle empty state based on parent selections
            if (level === 2 && levelSelections[1].size === 0) {
                listEl.innerHTML = '<li class="level-no-results">Select Level 1 (Party) first</li>';
                return;
            }
            if (level === 3 && (levelSelections[1].size === 0 || levelSelections[2].size === 0)) {
                const message = levelSelections[1].size === 0
                    ? 'Select Level 1 (Party) first'
                    : 'Select Level 2 (Function) first';
                listEl.innerHTML = `<li class="level-no-results">${message}</li>`;
                return;
            }

            // Filter values based on search
            const filteredValues = searchTerm
                ? values.filter(v => v.toLowerCase().includes(searchTerm))
                : values;

            if (filteredValues.length === 0) {
                listEl.innerHTML = '<li class="level-no-results">No matches found</li>';
                return;
            }

            // Determine input type
            let inputType = 'checkbox';
            if (level === 1) {
                const isMultiSelect = document.getElementById('level1MultiSelect')
                    ? document.getElementById('level1MultiSelect').checked
                    : false; // default to false if element missing (though it shouldn't be)
                if (!isMultiSelect) {
                    inputType = 'radio';
                }
            }

            listEl.innerHTML = filteredValues.map(val => {
                const isSelected = levelSelections[level].has(val);
                return `
                    <li class="level-list-item ${isSelected ? 'selected' : ''}" 
                        onclick="toggleLevelSelection(${level}, '${val.replace(/'/g, "\\'")}')">
                        <input type="${inputType}" class="level-checkbox" ${isSelected ? 'checked' : ''} disabled>
                        <span>${val}</span>
                    </li>
                `;
            }).join('');
        }

        // Check if all levels have at least one selection
        function hasValidSelections() {
            return levelSelections[1].size > 0 &&
                levelSelections[2].size > 0 &&
                levelSelections[3].size > 0;
        }

        // Auto-update generated roles based on current selections
        function updateGeneratedRoles() {
            // In wizard mode, we just update the data if valid, visibility is handled by steps
            if (hasValidSelections()) {
                generateRoles();
            } else {
                generatedRolesList = [];
                const listEl = document.getElementById('generatedRolesList');
                if (listEl) listEl.innerHTML = '';
                const countEl = document.getElementById('generatedRolesCount');
                if (countEl) countEl.textContent = 'Generated Roles';
            }
        }

        // Multi-select toggle handler
        function onMultiSelectToggle() {
            const isMultiSelect = document.getElementById('level1MultiSelect').checked;

            // If turning off multi-select and we have multiple selections, keep only the first one
            if (!isMultiSelect && levelSelections[1].size > 1) {
                // Get the most recently added item (last in the set iteration usually, but Set order is insertion order)
                // However, user interaction implies the last clicked one is most relevant, or we can just keep the first one.
                // Let's keep the last one added to be consistent with "current selection".
                const selections = Array.from(levelSelections[1]);
                const lastSelection = selections[selections.length - 1];

                levelSelections[1].clear();
                levelSelections[1].add(lastSelection);

                // Trigger cascading updates since we removed items
                const availableL2 = getAvailableLevel2();
                levelSelections[2].forEach(l2 => {
                    if (!availableL2.includes(l2)) {
                        levelSelections[2].delete(l2);
                    }
                });

                const availableL3 = getAvailableLevel3();
                levelSelections[3].forEach(l3 => {
                    if (!availableL3.includes(l3)) {
                        levelSelections[3].delete(l3);
                    }
                });

                renderLevelList(1, getAvailableLevel1());
                renderLevelList(2, getAvailableLevel2());
                renderLevelList(3, getAvailableLevel3());
                updateSelectionChips(1);
                updateSelectionChips(2);
                updateSelectionChips(3);
                updateGeneratedRoles();
            }
        }

        // Helper to apply defaults (General/All) when appropriate
        function ensureDefaultsSelected() {
            // Add "General" to L2 if available and not already selected
            const availableL2 = getAvailableLevel2();
            if (availableL2.includes('General') && !levelSelections[2].has('General')) {
                levelSelections[2].add('General');
            }

            // Add "All" to L3 if available and not already selected
            const availableL3 = getAvailableLevel3();
            if (availableL3.includes('All') && !levelSelections[3].has('All')) {
                levelSelections[3].add('All');
            }
        }

        // Toggle selection for an item
        function toggleLevelSelection(level, value) {
            // Handle single-select for Level 1
            if (level === 1) {
                const isMultiSelect = document.getElementById('level1MultiSelect').checked;
                if (!isMultiSelect && !levelSelections[1].has(value)) {
                    // In single select mode, clear other selections before adding new one
                    levelSelections[1].clear();
                }
            }

            if (levelSelections[level].has(value)) {
                levelSelections[level].delete(value);
            } else {
                levelSelections[level].add(value);
            }

            // When Level 1 changes, clear invalid Level 2 selections
            if (level === 1) {
                const availableL2 = getAvailableLevel2();
                // Check if any selected L2 are no longer invalid
                levelSelections[2].forEach(l2 => {
                    if (!availableL2.includes(l2)) {
                        levelSelections[2].delete(l2);
                    }
                });
                updateSelectionChips(2);

                // Also check L3 which depends on L2
                const availableL3 = getAvailableLevel3();
                levelSelections[3].forEach(l3 => {
                    if (!availableL3.includes(l3)) {
                        levelSelections[3].delete(l3);
                    }
                });
                updateSelectionChips(3);
            }

            // When Level 2 changes, clear invalid Level 3 selections
            if (level === 2) {
                const availableL3 = getAvailableLevel3();
                levelSelections[3].forEach(l3 => {
                    if (!availableL3.includes(l3)) {
                        levelSelections[3].delete(l3);
                    }
                });
                updateSelectionChips(3);
            }

            // Apply defaults to new valid selections (ensure General/All are selected if available)
            ensureDefaultsSelected();

            // Re-render all lists to update availability
            renderLevelList(1, getAvailableLevel1());
            renderLevelList(2, getAvailableLevel2());
            renderLevelList(3, getAvailableLevel3());

            updateSelectionChips(level);

            // Auto-generate roles when valid
            updateGeneratedRoles();
        }

        // Update selection chips display
        function updateSelectionChips(level) {
            const chipsEl = document.getElementById(`level${level}Chips`);
            const selections = Array.from(levelSelections[level]);

            if (selections.length === 0) {
                chipsEl.innerHTML = '';
                return;
            }

            chipsEl.innerHTML = selections.map(val => `
                <span class="selection-chip">
                    ${val}
                    <span class="remove-chip" onclick="event.stopPropagation(); removeSelection(${level}, '${val.replace(/'/g, "\\'")}')">&times;</span>
                </span>
            `).join('');

            // Update URL with current selections
            updateUrlWithSelections();
        }

        // Update URL query parameters with current Role Builder selections
        function updateUrlWithSelections() {
            const url = new URL(window.location.href);

            // Get current selections
            const l1 = Array.from(levelSelections[1]);
            const l2 = Array.from(levelSelections[2]);
            const l3 = Array.from(levelSelections[3]);

            // Update or remove l1 param
            if (l1.length > 0) {
                url.searchParams.set('l1', l1.join(','));
            } else {
                url.searchParams.delete('l1');
            }

            // Update or remove l2 param (exclude "General" as it's auto-added)
            const l2WithoutDefault = l2.filter(v => v !== 'General');
            if (l2WithoutDefault.length > 0) {
                url.searchParams.set('l2', l2WithoutDefault.join(','));
            } else {
                url.searchParams.delete('l2');
            }

            // Update or remove l3 param (exclude "All" as it's auto-added)
            const l3WithoutDefault = l3.filter(v => v !== 'All');
            if (l3WithoutDefault.length > 0) {
                url.searchParams.set('l3', l3WithoutDefault.join(','));
            } else {
                url.searchParams.delete('l3');
            }

            // Update browser URL without reloading the page
            window.history.replaceState({}, '', url.toString());
        }

        // Remove a selection
        function removeSelection(level, value) {
            levelSelections[level].delete(value);

            // Cascade: when removing L1, clean up L2 and L3
            if (level === 1) {
                const availableL2 = getAvailableLevel2();
                levelSelections[2].forEach(l2 => {
                    if (!availableL2.includes(l2)) {
                        levelSelections[2].delete(l2);
                    }
                });
                updateSelectionChips(2);

                const availableL3 = getAvailableLevel3();
                levelSelections[3].forEach(l3 => {
                    if (!availableL3.includes(l3)) {
                        levelSelections[3].delete(l3);
                    }
                });
                updateSelectionChips(3);
            }

            // When removing L2, clean up L3
            if (level === 2) {
                const availableL3 = getAvailableLevel3();
                levelSelections[3].forEach(l3 => {
                    if (!availableL3.includes(l3)) {
                        levelSelections[3].delete(l3);
                    }
                });
                updateSelectionChips(3);
            }

            renderLevelList(1, getAvailableLevel1());
            renderLevelList(2, getAvailableLevel2());
            renderLevelList(3, getAvailableLevel3());
            updateSelectionChips(level);

            // Auto-update generated roles
            updateGeneratedRoles();
        }

        // Filter level options based on search input
        function filterLevelOptions(level) {
            const searchBox = document.getElementById(`level${level}Search`);
            const clearBtn = document.getElementById(`level${level}ClearBtn`);

            // Show/hide clear button
            if (searchBox.value.length > 0) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }

            const values = level === 1 ? getAvailableLevel1()
                : level === 2 ? getAvailableLevel2()
                    : getAvailableLevel3();
            renderLevelList(level, values);
        }

        // Clear search for a level
        function clearLevelSearch(level) {
            const searchBox = document.getElementById(`level${level}Search`);
            const clearBtn = document.getElementById(`level${level}ClearBtn`);
            searchBox.value = '';
            clearBtn.classList.remove('visible');
            filterLevelOptions(level);
            searchBox.focus();
        }

        // Generate roles using the same logic as TarmacApp's RoleResolverService.Resolve()
        function generateRoles() {
            // Get selected values from our selection sets
            const selectedL1 = Array.from(levelSelections[1]);
            const selectedL2 = Array.from(levelSelections[2]);
            const selectedL3 = Array.from(levelSelections[3]);

            // Early return if no valid selections (no alert needed since UI updates reactively)
            if (selectedL1.length === 0 || selectedL3.length === 0) {
                return;
            }

            // Apply Resolve() logic: L2 set is whatever is selected (defaults are now explicit in selection)
            const l2Array = selectedL2;

            // Check if L3 only contains "All"
            const includeAllForAnyL2 = selectedL3.length === 1 && selectedL3[0].toLowerCase() === 'all';

            // Generate cross-product of L1 Ã— L2 Ã— L3
            const roles = [];
            for (const l1 of selectedL1) {
                for (const l2 of l2Array) {
                    for (const l3 of selectedL3) {
                        // Apply the same logic as Resolve()
                        if (includeAllForAnyL2 ||
                            l2.toLowerCase() === 'general' ||
                            l3.toLowerCase() !== 'all') {
                            const roleName = `${l1} - ${l2} - ${l3}`;
                            roles.push(roleName);
                        }
                    }
                }
            }

            // Always include "All Members" role
            roles.push("All Members");

            // Store and display generated roles
            generatedRolesList = [...new Set(roles)].sort();
            displayGeneratedRoles(generatedRolesList);
        }

        // Display generated roles in the results section
        function displayGeneratedRoles(roles) {
            const section = document.getElementById('generatedRolesSection');
            const countEl = document.getElementById('generatedRolesCount');
            const listEl = document.getElementById('generatedRolesList');

            if (roles.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            countEl.textContent = `Generated ${roles.length} role${roles.length !== 1 ? 's' : ''}`;

            listEl.innerHTML = roles.map(role => `
                <li class="role-item">
                    <span class="role-name">${role}</span>
                    <button class="copy-btn" onclick="copyToClipboard('${role.replace(/'/g, "\\'")}', this)" title="Copy to clipboard">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                    </button>
                </li>
            `).join('');

            // Update shareable URL
            updateShareableUrl();
        }

        // Generate and update the shareable URL
        function updateShareableUrl() {
            const urlInput = document.getElementById('shareableUrl');
            if (!urlInput) return;

            const selectedL1 = Array.from(levelSelections[1]);
            const selectedL2 = Array.from(levelSelections[2]);
            const selectedL3 = Array.from(levelSelections[3]);

            // Build URL with current selections
            const baseUrl = window.location.origin + window.location.pathname;
            const params = new URLSearchParams();

            if (selectedL1.length > 0) params.set('l1', selectedL1.join(','));
            if (selectedL2.length > 0) params.set('l2', selectedL2.join(','));
            if (selectedL3.length > 0) params.set('l3', selectedL3.join(','));

            const newUrl = baseUrl + '?' + params.toString() + '#RoleBuilder';
            urlInput.value = newUrl;

            // Sync browser URL without reloading
            window.history.replaceState(null, '', newUrl);
        }

        // Copy shareable URL to clipboard
        function copyShareableUrl() {
            const urlInput = document.getElementById('shareableUrl');
            if (!urlInput || !urlInput.value) return;

            navigator.clipboard.writeText(urlInput.value).then(function () {
                // Show brief feedback
                const btn = urlInput.nextElementSibling;
                if (btn) {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = 'âœ“';
                    btn.style.color = '#28a745';
                    setTimeout(function () {
                        btn.innerHTML = originalHTML;
                        btn.style.color = '';
                    }, 1500);
                }
            }).catch(function (err) {
                console.error('Failed to copy URL: ', err);
                alert('Failed to copy URL');
            });
        }

        // Copy all generated roles
        function copyAllGeneratedRoles(copyAllBtn) {
            if (generatedRolesList.length === 0) {
                alert('No generated roles to copy');
                return;
            }

            // Fallback if button not passed (though we updated HTML)
            if (!copyAllBtn) {
                // Try to find it in DOM or just use alert
                copyAllBtn = document.querySelector('#generatedRolesSection .copy-all-btn');
            }

            const allRolesText = generatedRolesList.join('\n');
            navigator.clipboard.writeText(allRolesText).then(function () {
                if (copyAllBtn) {
                    const originalHTML = copyAllBtn.innerHTML;
                    copyAllBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                        </svg>
                        Copied!
                    `;
                    copyAllBtn.classList.add('copied');
                    setTimeout(function () {
                        copyAllBtn.innerHTML = originalHTML;
                        copyAllBtn.classList.remove('copied');
                    }, 2000);
                } else {
                    alert(`Copied ${generatedRolesList.length} roles to clipboard`);
                }
            }).catch(function (err) {
                console.error('Failed to copy generated roles: ', err);
                alert('Failed to copy to clipboard');
            });
        }

        // ========== END ROLE BUILDER FUNCTIONS ==========

        // Snackbar notification system
        let snackbarTimeout = null;

        function showSnackbar(message) {
            const snackbar = document.getElementById('snackbar');
            const messageEl = document.getElementById('snackbarMessage');

            // Don't show if Roles tab is already active
            const rolesTab = document.getElementById('Roles');
            if (rolesTab && rolesTab.style.display !== 'none') {
                return;
            }

            // Clear any existing timeout
            if (snackbarTimeout) {
                clearTimeout(snackbarTimeout);
                snackbar.classList.remove('show');
            }

            messageEl.textContent = message;
            snackbar.classList.add('show');

            snackbarTimeout = setTimeout(function () {
                snackbar.classList.remove('show');
            }, 5000);
        }

        function navigateToRolesTab() {
            const rolesTabBtn = document.querySelector('.tab-link[onclick*="Roles"]');
            if (rolesTabBtn) {
                rolesTabBtn.click();
            }
            // Hide snackbar immediately
            const snackbar = document.getElementById('snackbar');
            snackbar.classList.remove('show');
            if (snackbarTimeout) {
                clearTimeout(snackbarTimeout);
            }
        }

        // Listen for chart clicks
        // Listen for messages from iframe (cross-origin safe)
        window.addEventListener('message', function (event) {
            // Handle chart data
            if (event.data && event.data.type === 'chartData') {
                cachedChartData = event.data.data;
                // Initial load of roles list
                updateRolesList();
                // Also populate Role Builder selects
                populateRoleBuilderSelects();
            }

            // Handle chart click
            if (event.data && event.data.type === 'chartClick') {
                lastClickedData = event.data.data;
                const clickedId = event.data.data.id;
                const clickedParent = event.data.data.parent;

                // Compute the filter ID at click time (handles go-back logic)
                if (previousClickedId === clickedId) {
                    // Clicked same item - go back up to parent
                    if (clickedParent && clickedParent !== '') {
                        currentFilterId = clickedParent;
                        previousClickedId = clickedParent;
                    } else {
                        // At root level, reset filter
                        currentFilterId = null;
                        previousClickedId = null;
                    }
                } else {
                    // New item clicked - set as filter
                    currentFilterId = clickedId;
                    previousClickedId = clickedId;
                }

                // Update roles list in background and show notification
                updateRolesList();
                const label = currentFilterId ? event.data.data.label : 'all';
                if (currentFilterId) {
                    showSnackbar(`Roles filtered by "${label}". Click the Roles tab to view.`);
                } else {
                    showSnackbar('Roles reset to show all. Click the Roles tab to view.');
                }
            }

            // Handle chart double-click (reset)
            if (event.data && event.data.type === 'chartDoubleClick') {
                lastClickedData = null;
                previousClickedId = null;
                currentFilterId = null;

                // Update roles list in background and show notification
                updateRolesList();
                showSnackbar('Roles reset to show all. Click the Roles tab to view.');
            }
        });

        function setupChartListener() {
            // This function is now a no-op as we use postMessage for cross-origin communication
            // The message listener above handles all the chart communication
        }

        // Ensure the first tab is opened on load or based on URL
        document.addEventListener("DOMContentLoaded", function () {
            setupChartListener();

            // Handle Search Param
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('search');
            let searchHasRoleTarget = false;

            if (searchParam) {
                const searchBox = document.getElementById('roleSearch');
                if (searchBox) {
                    searchBox.value = searchParam;
                    // Ensure the clear button handles visibility correctly if needed, 
                    // though filterRoles() calls it, filterRoles needs currentRolesList which might not be ready.
                    // Actual filtering will trigger when updateRolesList is called by chart load or tab click.
                }
                searchHasRoleTarget = true;
            }

            // Handle Role Builder URL parameters (l1, l2, l3)
            const l1Param = urlParams.get('l1');
            const l2Param = urlParams.get('l2');
            const l3Param = urlParams.get('l3');
            // noDefaults parameter is deprecated and ignored
            let roleBuilderFromUrl = false;

            if (l1Param) {
                // Parse comma-separated values for Level 1
                const l1Values = l1Param.split(',').map(v => v.trim()).filter(v => v);
                const availableL1 = getAvailableLevel1();

                l1Values.forEach(val => {
                    if (availableL1.includes(val)) {
                        levelSelections[1].add(val);
                    }
                });

                if (levelSelections[1].size > 0) {
                    // Parse Level 2 values if provided
                    if (l2Param) {
                        const l2Values = l2Param.split(',').map(v => v.trim()).filter(v => v);
                        const availableL2 = getAvailableLevel2();

                        l2Values.forEach(val => {
                            if (availableL2.includes(val)) {
                                levelSelections[2].add(val);
                            }
                        });
                    }

                    // Auto-add "General" to Level 2 if available and not set (only if L2 param was missing)
                    // If L2 param exists, we assume it's explicit. 
                    // However, old links without explicit "General" might need it.
                    // Let's stick to explicit behavior: if L2 param is present, key off that.
                    // But for first load, ensuring standard defaults (General/All) is good behavior if they're missing.
                    if (levelSelections[2].size === 0) {
                        const availableL2 = getAvailableLevel2();
                        if (availableL2.includes('General')) {
                            levelSelections[2].add('General');
                        }
                    } else {
                        // Ensure General is there if available (implicit default behavior we had before)
                        // Actually the user request is "include all possible selections... in the URL".
                        // So if the URL loads, we trust the URL. If the URL misses "General", we effectively don't select it?
                        // BUT, the system logic strongly prefers General/All being present.
                        // Let's ensure they are added if valid options, to be safe.
                        const availableL2 = getAvailableLevel2();
                        if (availableL2.includes('General') && !levelSelections[2].has('General')) {
                            // If user explicitly crafted a URL without General, should we force it?
                            // Yes, based on current app logic where General is standard.
                            levelSelections[2].add('General');
                        }
                    }

                    if (levelSelections[2].size > 0) {
                        // Parse Level 3 values if provided
                        if (l3Param) {
                            const l3Values = l3Param.split(',').map(v => v.trim()).filter(v => v);
                            const availableL3 = getAvailableLevel3();

                            l3Values.forEach(val => {
                                if (availableL3.includes(val)) {
                                    levelSelections[3].add(val);
                                }
                            });
                        }

                        // Auto-add "All" to Level 3 if available
                        const availableL3 = getAvailableLevel3();
                        if (availableL3.includes('All') && !levelSelections[3].has('All')) {
                            levelSelections[3].add('All');
                        }

                        if (levelSelections[3].size > 0) {
                            roleBuilderFromUrl = true;
                        }
                    }
                }
            }

            // Handle Tab Hash
            const hash = window.location.hash.substring(1);
            const tabLinks = document.getElementsByClassName("tab-link");
            let tabToOpen = tabLinks[0]; // Default to first

            // If Role Builder params were provided, go to Role Builder tab
            if (roleBuilderFromUrl) {
                for (let i = 0; i < tabLinks.length; i++) {
                    const onclickAttr = tabLinks[i].getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`'RoleBuilder'`)) {
                        tabToOpen = tabLinks[i];
                        break;
                    }
                }
            }
            // If hash is present, try to find matching tab
            else if (hash) {
                for (let i = 0; i < tabLinks.length; i++) {
                    // Extract tab name from onclick attribute: openTab(event, 'TabName')
                    const onclickAttr = tabLinks[i].getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`'${hash}'`)) {
                        tabToOpen = tabLinks[i];
                        break;
                    }
                }
            } else if (searchHasRoleTarget) {
                // If no hash but we have search, default to Roles tab
                for (let i = 0; i < tabLinks.length; i++) {
                    const onclickAttr = tabLinks[i].getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`'Roles'`)) {
                        tabToOpen = tabLinks[i];
                        break;
                    }
                }
            }

            // Click the determined tab
            if (tabToOpen) {
                tabToOpen.click();
            }

            // If Role Builder from URL, generate roles and go to Step 4
            if (roleBuilderFromUrl) {
                // Update all chips and lists
                renderLevelList(1, getAvailableLevel1());
                renderLevelList(2, getAvailableLevel2());
                renderLevelList(3, getAvailableLevel3());
                updateSelectionChips(1);
                updateSelectionChips(2);
                updateSelectionChips(3);

                // Generate roles and go to results
                generateRoles();
                goToStep(4);
            }
        });

        // ========== WIZARD LOGIC ==========
        let currentStep = 1;

        function updateStepSummaries(step) {
            const summaryEl = document.getElementById(`step${step}Summary`);
            if (!summaryEl) return;

            let html = '';

            // For Step 2, show Level 1 selection
            if (step >= 2) {
                const l1 = Array.from(levelSelections[1]).join(', ');
                if (l1) html += `<span class="summary-item"><span class="summary-label">Party:</span> ${l1}</span>`;
            }

            // For Step 3, show Level 1 & 2
            if (step >= 3) {
                const l2 = Array.from(levelSelections[2]).join(', ');
                if (l2) html += `<span class="summary-item"><span class="summary-label">Function:</span> ${l2}</span>`;
            }

            // For Step 4, show Level 1, 2 & 3
            if (step >= 4) {
                const l3 = Array.from(levelSelections[3]).join(', ');
                if (l3) html += `<span class="summary-item"><span class="summary-label">Discipline:</span> ${l3}</span>`;
            }

            summaryEl.innerHTML = html;
            summaryEl.style.display = html ? 'block' : 'none';
        }

        function goToStep(step) {
            // Validate before moving forward
            if (step > 1 && levelSelections[1].size === 0) {
                alert("Please select a Party (Level 1) first.");
                return;
            }
            if (step > 2 && levelSelections[2].size === 0) {
                alert("Please select a Function (Level 2) first.");
                return;
            }

            // Update Step UI
            document.querySelectorAll('.builder-step').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');

            // Update Summary for this step
            updateStepSummaries(step);

            // Update Breadcrumbs
            currentStep = step;
            for (let i = 1; i <= 4; i++) {
                const crumb = document.getElementById(`crumb${i}`);
                if (crumb) {
                    crumb.classList.remove('active', 'completed');
                    if (i === step) {
                        crumb.classList.add('active');
                    } else if (i < step) {
                        crumb.classList.add('completed');
                    }
                }
            }

            // Refresh lists in the new step to ensure sizing is correct and focus is set
            if (step <= 3) {
                setTimeout(() => {
                    renderLevelList(step, step === 1 ? getAvailableLevel1() : (step === 2 ? getAvailableLevel2() : getAvailableLevel3()));
                }, 50);
            }

            // Auto-select "General" when entering Step 2 if it's available
            if (step === 2) {
                const availableL2 = getAvailableLevel2();
                const generalNote = document.getElementById('generalDefaultNote');
                if (availableL2.includes('General')) {
                    // Add "General" to selections if not already selected
                    if (!levelSelections[2].has('General')) {
                        levelSelections[2].add('General');
                        updateSelectionChips(2);
                        renderLevelList(2, availableL2);
                    }
                    // Show the note
                    if (generalNote) generalNote.style.display = 'block';
                } else {
                    // Hide the note if General is not available
                    if (generalNote) generalNote.style.display = 'none';
                }
            }

            // Auto-select "All" when entering Step 3 if it's available
            if (step === 3) {
                const availableL3 = getAvailableLevel3();
                const allNote = document.getElementById('allDefaultNote');
                if (availableL3.includes('All')) {
                    // Add "All" to selections if not already selected
                    if (!levelSelections[3].has('All')) {
                        levelSelections[3].add('All');
                        updateSelectionChips(3);
                        renderLevelList(3, availableL3);
                    }
                    // Show the note
                    if (allNote) allNote.style.display = 'block';
                } else {
                    // Hide the note if All is not available
                    if (allNote) allNote.style.display = 'none';
                }
            }
        }

        function canGoToStep(step) {
            if (step === 1) return true;
            if (step === 2) return levelSelections[1].size > 0;
            if (step === 3) return levelSelections[1].size > 0 && levelSelections[2].size > 0;
            if (step === 4) return hasValidSelections();
            return false;
        }

        function generateRolesWizard() {
            if (!hasValidSelections()) {
                alert("Please make selections in all 3 levels.");
                return;
            }
            generateRoles();
            goToStep(4);
        }

        function resetWizard() {
            levelSelections[1].clear();
            levelSelections[2].clear();
            levelSelections[3].clear();

            renderLevelList(1, getAvailableLevel1());
            renderLevelList(2, getAvailableLevel2());
            renderLevelList(3, getAvailableLevel3());

            updateSelectionChips(1);
            updateSelectionChips(2);
            updateSelectionChips(3);

            goToStep(1);
        }
    </script>
</body>

</html>